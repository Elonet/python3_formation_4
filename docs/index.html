<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elonet | Python 3 | Formation 4</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__left">
    <div class="stackedit__toc">
      
<ul>
<li><a href="#python-3-formation-4">Python 3 Formation 4</a></li>
<li><a href="#micro-service">1 - Micro service</a>
<ul>
<li><a href="#mise-en-place-du-micro-service">Mise en place du micro service</a></li>
<li><a href="#description-des-données">Description des données</a></li>
<li><a href="#ajout-de-la-route">Ajout de la route</a></li>
<li><a href="#vérifier-les-emails">Vérifier les emails</a></li>
<li><a href="#templating-des-emails">Templating des emails</a></li>
<li><a href="#envoi-de-email">Envoi de email</a></li>
</ul>
</li>
<li><a href="#loggers">2 - Loggers</a>
<ul>
<li><a href="#python-et-les-loggers">Python et les loggers</a></li>
<li><a href="#flask-et-le-logging">Flask et le logging</a></li>
</ul>
</li>
<li><a href="#celery">3 - Celery</a>
<ul>
<li><a href="#concept">Concept</a></li>
<li><a href="#installation-1">Installation</a></li>
<li><a href="#usage-1">Usage</a></li>
<li><a href="#en-dehors-du-contexte-dexécution-de-notre-programme">En dehors du contexte d’exécution de notre programme</a></li>
<li><a href="#plus-de-détail-sur-les-taches">Plus de détail sur les taches</a></li>
<li><a href="#celery-et-flask">Celery et Flask</a></li>
</ul>
</li>
<li><a href="#docker">4 - Docker</a>
<ul>
<li><a href="#créer-un-container-de-notre-application-flask">Créer un container de notre application Flask</a></li>
<li><a href="#packager-notre-application-et-son-environnement">Packager notre application et son environnement</a></li>
</ul>
</li>
<li><a href="#nginx">5 - Nginx</a>
<ul>
<li><a href="#mise-en-place-1">Mise en place</a></li>
</ul>
</li>
</ul>

    </div>
  </div>
  <div class="stackedit__right">
    <div class="stackedit__html">
      <h1 id="python-3-formation-4">Python 3 Formation 4</h1>
<h1 id="micro-service">1 - Micro service</h1>
<p>Dans la précédente formation, nous avons vu comment construire un service REST à l’aide de Flask et de l’extension Flask RestPlus, nous allons maintenant mettre ça en pratique à travers un micro-service d’envoi d’emails.<br>
L’objectif est de pouvoir envoyer un email à un grand nombre de personnes tout en ayant un service qui répond très rapidement aux requêtes.</p>
<h2 id="mise-en-place-du-micro-service">Mise en place du micro service</h2>
<p>Afin de ne pas trop revenir sur le chapitre précédent, je vous fournis une template de micro-service Flask RestPlus que vous pourrez réutiliser dans vos projets.</p>
<p>Copier le projet : <a href="https://github.com/averdier/restplus_template">https://github.com/averdier/restplus_template</a> et renommer le dossier en <code>email_service</code></p>
<pre><code>git clone https://github.com/averdier/restplus_template
mv restplus_template/ email_service
cd email_service
virtualenv -p python3 env
source env/bin/activate
pip install -r requirements.txt
</code></pre>
<p>Vous pouvez dès maintenant lancer la solution :</p>
<pre><code>python runserver.py
</code></pre>
<h2 id="description-des-données">Description des données</h2>
<p>La première chose à faire est de décrire les données attendues par le micro service.<br>
Pour envoyer des emails, il nous faut au moins les informations suivantes :</p>
<ul>
<li>Une liste de destinataires</li>
<li>Un titre</li>
<li>Un corps<br>
Nous allons utiliser un système de templates de email, nous pouvons donc rajouter :</li>
<li>Nom de la template<br>
Ajoutons un fichier <code>email.py</code> dans le dossier <code>email_service/app/api/serializers</code></li>
</ul>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> flask_restplus <span class="token keyword">import</span> fields
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">import</span> api

send_email_model <span class="token operator">=</span> api<span class="token punctuation">.</span>model<span class="token punctuation">(</span><span class="token string">'Send Email model'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'recipients'</span><span class="token punctuation">:</span> fields<span class="token punctuation">.</span>List<span class="token punctuation">(</span>fields<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Recipients list'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'subject'</span><span class="token punctuation">:</span> fields<span class="token punctuation">.</span>String<span class="token punctuation">(</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Email subject'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'content'</span><span class="token punctuation">:</span> fields<span class="token punctuation">.</span>String<span class="token punctuation">(</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Email content'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'template'</span><span class="token punctuation">:</span> fields<span class="token punctuation">.</span>String<span class="token punctuation">(</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Email template'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>Nous pourrions rajouter des règles de validation par exemple un sujet compris en 3 et 32 caractères, à ce niveau la vous êtes libres de faire comme bon vous semble.</p>
<p>Exemple :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token string">'subject'</span><span class="token punctuation">:</span> fields<span class="token punctuation">.</span>String<span class="token punctuation">(</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> min_length<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Email subject'</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="ajout-de-la-route">Ajout de la route</h2>
<p>La prochaine étape et d’ajouter la route qui va permettre l’envoi de email, cette route comportera au moins la méthode POST qui permettra d’envoyer les données permettant d’envoyer les emails.</p>
<p>Ajoutons un fichier <code>email.py</code> dans le dossier <code>email_service/app/api/endpoints</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> request
<span class="token keyword">from</span> flask_restplus <span class="token keyword">import</span> Namespace<span class="token punctuation">,</span> Resource
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>serializers<span class="token punctuation">.</span>email <span class="token keyword">import</span> send_email_model

ns <span class="token operator">=</span> Namespace<span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Email related operation'</span><span class="token punctuation">)</span>

<span class="token comment"># =========================================================================</span>
<span class="token comment"># ENDPOINTS</span>
<span class="token comment"># =========================================================================</span>
<span class="token comment">#   API email endpoints</span>
<span class="token comment">#</span>
<span class="token comment"># =========================================================================</span>

@ns<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">EmailSend</span><span class="token punctuation">(</span>Resource<span class="token punctuation">)</span><span class="token punctuation">:</span>
    @ns<span class="token punctuation">.</span>expect<span class="token punctuation">(</span>send_email_model<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Send email
        """</span>
        data <span class="token operator">=</span> request<span class="token punctuation">.</span>json
</code></pre>
<p>Ici nous avons défini une route <code>/api/email</code> qui attend les données au format <code>send_email_model</code> en POST.</p>
<p>Nous récupérons l’ensemble des données disponibles à l’aide de <code>request.json</code></p>
<blockquote>
<p>Pensez à modifier le fichier <code>email_service/app/api/__init__.py</code> afin de prendre en compte la route</p>
</blockquote>
<h2 id="vérifier-les-emails">Vérifier les emails</h2>
<p>Afin de limiter les erreurs lors de l’envoi de email, nous allons vérifier que les adresses email fournies sont bien des adresses email.</p>
<p>Pour cela nous allons utiliser les regex.</p>
<p>Python possède déjà la bibliothèque pour traiter les regex, il suffit de faire un import :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> re
</code></pre>
<p>L’usage de la bibliothèque est assez simple, il suffit d’utiliser la fonction <code>match</code> qui attend en paramètre l’expression régulière et la valeur à tester.</p>
<p>En retour la fonction retourne <code>True</code> si la valeur correspond à l’expression, <code>False</code> sinon.</p>
<pre class=" language-python"><code class="prism  language-python">re<span class="token punctuation">.</span>match<span class="token punctuation">(</span>r<span class="token string">"(^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$)"</span><span class="token punctuation">,</span> email<span class="token punctuation">)</span>
</code></pre>
<p>Dans le cas ou un email ne passe pas l’expression régulière, nous allons retourner un code d’erreur 400 à l’aide de la fonction <code>abort</code></p>
<p>Ce qui nous donne :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> re
<span class="token keyword">from</span> flask <span class="token keyword">import</span> request
<span class="token keyword">from</span> flask_restplus <span class="token keyword">import</span> Namespace<span class="token punctuation">,</span> Resource<span class="token punctuation">,</span>abort
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>serializers<span class="token punctuation">.</span>email <span class="token keyword">import</span> send_email_model

ns <span class="token operator">=</span> Namespace<span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Email related operation'</span><span class="token punctuation">)</span>

<span class="token comment"># =========================================================================</span>
<span class="token comment"># ENDPOINTS</span>
<span class="token comment"># =========================================================================</span>
<span class="token comment">#   API email endpoints</span>
<span class="token comment">#</span>
<span class="token comment"># =========================================================================</span>

@ns<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">EmailSend</span><span class="token punctuation">(</span>Resource<span class="token punctuation">)</span><span class="token punctuation">:</span>
    @ns<span class="token punctuation">.</span>expect<span class="token punctuation">(</span>send_email_model<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Send email
        """</span>
        data <span class="token operator">=</span> request<span class="token punctuation">.</span>json
        <span class="token keyword">for</span> email <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">'recipients'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token operator">not</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span>r<span class="token string">"(^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$)"</span><span class="token punctuation">,</span> email<span class="token punctuation">)</span><span class="token punctuation">:</span>
                abort<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> error<span class="token operator">=</span><span class="token string">'{0} not pass email regex.'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="templating-des-emails">Templating des emails</h2>
<p>Nous allons mettre en place le système de template de email à l’aide du moteur de template JinJa2.</p>
<p>Lors de la précédente formation, nous avons vu qu’il était possible d’utiliser JinJa2 pour faire des templates de page HTML, mais il est tout à fait possible de l’utiliser à d’autres fins.</p>
<p>Créons un dossier <code>templates</code> dans le dossier <code>email_service/app</code> et ajoutons un fichier <code>default.eml</code> à l’intérieur</p>
<pre class=" language-jinja"><code class="prism  language-jinja">Date: {{date}}
From: {{from}}
To: {{to}}
Subject: {{subject}}
Content-Type: text/plain

{{ content }}

--
Email service
</code></pre>
<p>Nous pouvons maintenant rendre notre template à l’aide de l’objet <code>Template</code> de JinJa2 :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">from</span> email<span class="token punctuation">.</span>utils <span class="token keyword">import</span> format_datetime
<span class="token keyword">from</span> jinja2 <span class="token keyword">import</span> Template

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'date'</span><span class="token punctuation">:</span> format_datetime<span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'to'</span><span class="token punctuation">:</span> <span class="token string">'will@elonet.fr'</span><span class="token punctuation">,</span>
        <span class="token string">'from'</span><span class="token punctuation">:</span> <span class="token string">'eleven@elonet.fr'</span><span class="token punctuation">,</span>
        <span class="token string">'subject'</span><span class="token punctuation">:</span> <span class="token string">'Demogorgon'</span><span class="token punctuation">,</span>
        <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'Run for your life'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'&lt;file path&gt;'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> template_file<span class="token punctuation">:</span>
        template <span class="token operator">=</span> Template<span class="token punctuation">(</span>template_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span>render<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>Ce qui nous donne le résultat suivant :</p>
<pre><code>Date: Thu, 14 Jun 2018 15:03:07 -0000
From: eleven@elonet.fr
To : will@elonet.fr
Subject: Demogorgon
Content-Type: text/plain

Run for your life

--
Email service
</code></pre>
<p>Afin de rendre la logique modulable et réutilisable, créons un fichier <code>utils.py</code> dans le dossier <code>email_service/app</code>, ce fichier contiendra la fonction <code>render_email</code> qui prendra en paramètre le nom de la template et un dictionnaire de données :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> jinja2 <span class="token keyword">import</span> Template

<span class="token keyword">def</span> <span class="token function">render_email</span><span class="token punctuation">(</span>template_name<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Render email template
    
    :param template_name: Name of email template
    :type template_name: str
    
    :param data: Data of email
    :type data: dict
    
    :return: Rendered email
    :rtype: str 
    """</span>
    basedir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>basedir <span class="token operator">+</span> <span class="token string">'/templates/'</span> <span class="token operator">+</span> template_name <span class="token operator">+</span> <span class="token string">'.eml'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> template_file<span class="token punctuation">:</span>
        template <span class="token operator">=</span> Template<span class="token punctuation">(</span>template_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> template<span class="token punctuation">.</span>render<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</code></pre>
<p>Nous pouvons maintenant générer des emails, il nous reste a les envoyer</p>
<h2 id="envoi-de-email">Envoi de email</h2>
<p>Pour simplifier l’envoi de emails, nous allons utiliser l’extension Flask-Mail (<a href="https://pythonhosted.org/Flask-Mail/">https://pythonhosted.org/Flask-Mail/</a>)</p>
<h3 id="installation">Installation</h3>
<p>Pour l’installation nous allons utiliser notre fidèle <code>pip</code></p>
<pre><code>pip install flask-mail
</code></pre>
<p>Nous allons ensuite ajouter l’extension à notre application, créons un fichier <code>extensions.py</code> dans le dossier <code>email_service/app</code> :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> flask_mail <span class="token keyword">import</span> Mail

mail <span class="token operator">=</span> Mail<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Il faut ensuite modifier le fichier <code>__init__.py</code> présent dans le dossier <code>email_service/app</code> afin de bien ajouter notre extension :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span>extensions <span class="token keyword">import</span> mail
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">def</span> <span class="token function">extensions</span><span class="token punctuation">(</span>flask_app<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Init extensions
    :param flask_app:
    """</span>
    mail<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>flask_app<span class="token punctuation">)</span>
</code></pre>
<h3 id="configuration">Configuration</h3>
<p>Flask-Mail nécessite une configuration à fournir dans la configuration de notre application.<br>
Extrait de la documentation :</p>

<table>
<thead>
<tr>
<th>Champ</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>MAIL_SERVER</td>
<td>default <code>localhost</code></td>
</tr>
<tr>
<td>MAIL_PORT</td>
<td>default <code>25</code></td>
</tr>
<tr>
<td>MAIL_USE_TLS</td>
<td>default <code>False</code></td>
</tr>
<tr>
<td>MAIL_USE_SLL</td>
<td>default <code>False</code></td>
</tr>
<tr>
<td>MAIL_DEBUG</td>
<td>default <code>app.debug</code></td>
</tr>
<tr>
<td>MAIL_USERNAME</td>
<td>default <code>None</code></td>
</tr>
<tr>
<td>MAIL_PASSWORD</td>
<td>default <code>None</code></td>
</tr>
<tr>
<td>MAIL_DEFAULT_SENDER</td>
<td>default <code>None</code></td>
</tr>
<tr>
<td>MAIL_MAX_EMAILS</td>
<td>default <code>None</code></td>
</tr>
<tr>
<td>MAIL_SUPPRESS_SEND</td>
<td>default <code>app.testing</code></td>
</tr>
<tr>
<td>MAIL_ASCII_ATTACHEMENTS</td>
<td>default <code>False</code></td>
</tr>
</tbody>
</table><p>Il n’est pas nécessaire de renseigner l’ensemble des champs dans la mesure ou chaque champ possède une valeur par défaut.</p>
<p>Modifions notre fichier <code>config.py</code> présent dans le dossier <code>email_service</code> afin d’ajouter la configuration nécessaire à l’envoi de emails.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Base configuration
    """</span>
    MAIL_SERVER <span class="token operator">=</span> <span class="token string">''</span>
    MAIL_PORT <span class="token operator">=</span> <span class="token string">''</span>
    MAIL_USE_TLS <span class="token operator">=</span> <span class="token boolean">False</span>
    MAIL_USE_SSL <span class="token operator">=</span> <span class="token boolean">True</span>
    MAIL_USERNAME <span class="token operator">=</span> <span class="token string">''</span>
    MAIL_PASSWORD <span class="token operator">=</span> <span class="token string">''</span>
    MAIL_DEFAULT_SENDER <span class="token operator">=</span> <span class="token string">''</span>
    @<span class="token builtin">staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">init_app</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Init app
        :param app: Flask App
        :type app: Flask
        """</span>
        <span class="token keyword">pass</span>
</code></pre>
<p>Il ne nous restera plus qu’à fournir les informations nécessaires.</p>
<h3 id="usage">Usage</h3>
<p>À présent, voyons comment envoyer nos emails, pour cela nous allons modifier le fichier <code>email.py</code> dans le dossier <code>email_service/app/api/endpoints</code>.</p>
<p>Flask-Mail permet déjà d’envoyer un email à une grande quantité de personnes, le <strong>Bulk email</strong>, le code est fourni dans la documentation :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">with</span> mail<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
    <span class="token keyword">for</span> user <span class="token keyword">in</span> users<span class="token punctuation">:</span>
        message <span class="token operator">=</span> <span class="token string">'...'</span>
        subject <span class="token operator">=</span> <span class="token string">"hello, %s"</span> <span class="token operator">%</span> user<span class="token punctuation">.</span>name
        msg <span class="token operator">=</span> Message<span class="token punctuation">(</span>recipients<span class="token operator">=</span><span class="token punctuation">[</span>user<span class="token punctuation">.</span>email<span class="token punctuation">]</span><span class="token punctuation">,</span>
                      body<span class="token operator">=</span>message<span class="token punctuation">,</span>
                      subject<span class="token operator">=</span>subject<span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
</code></pre>
<p>Dans notre template de email, nous avons mis un paramètre <code>from</code>, pour le remplir nous allons utiliser la propriété <code>MAIL_DEFAULT_SENDER</code> présente dans notre configuration.</p>
<p>Pour cela nous allons utiliser la variable <code>current_app</code> présente dans <code>Flask</code>, grâce à cette variable nous avons accès à la configuration de notre application :</p>
<pre class=" language-python"><code class="prism  language-python">mail_sender <span class="token operator">=</span> current_app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'MAIL_DEFAULT_SENDER'</span><span class="token punctuation">]</span>
</code></pre>
<p>Maintenant le tout ensemble :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> re
<span class="token keyword">from</span> flask <span class="token keyword">import</span> request<span class="token punctuation">,</span> current_app
<span class="token keyword">from</span> flask_restplus <span class="token keyword">import</span> Namespace<span class="token punctuation">,</span> Resource<span class="token punctuation">,</span> abort
<span class="token keyword">from</span> flask_mail <span class="token keyword">import</span> Message
<span class="token keyword">from</span> app<span class="token punctuation">.</span>extensions <span class="token keyword">import</span> mail
<span class="token keyword">from</span> app<span class="token punctuation">.</span>utils <span class="token keyword">import</span> render_email
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>serializers<span class="token punctuation">.</span>email <span class="token keyword">import</span> send_email_model

ns <span class="token operator">=</span> Namespace<span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Email related operation'</span><span class="token punctuation">)</span>

<span class="token comment"># =========================================================================</span>
<span class="token comment"># ENDPOINTS</span>
<span class="token comment"># =========================================================================</span>
<span class="token comment">#   API email endpoints</span>
<span class="token comment">#</span>
<span class="token comment"># =========================================================================</span>

@ns<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">EmailSend</span><span class="token punctuation">(</span>Resource<span class="token punctuation">)</span><span class="token punctuation">:</span>
    @ns<span class="token punctuation">.</span>expect<span class="token punctuation">(</span>send_email_model<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Send email
        """</span>
        data <span class="token operator">=</span> request<span class="token punctuation">.</span>json
        <span class="token keyword">for</span> email <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">'recipients'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token operator">not</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span>r<span class="token string">"(^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$)"</span><span class="token punctuation">,</span> email<span class="token punctuation">)</span><span class="token punctuation">:</span>
                current_app<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'{0} not pass email regex.'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">)</span>
                abort<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> error<span class="token operator">=</span><span class="token string">'{0} not pass email regex.'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> mail<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
            <span class="token keyword">for</span> email <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">'recipients'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                payload <span class="token operator">=</span> <span class="token punctuation">{</span>
                    <span class="token string">'from'</span><span class="token punctuation">:</span> current_app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'MAIL_DEFAULT_SENDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">'to'</span><span class="token punctuation">:</span> email<span class="token punctuation">,</span>
                    <span class="token string">'subject'</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token string">'subject'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">'content'</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
                msg <span class="token operator">=</span> Message<span class="token punctuation">(</span>
                    recipients<span class="token operator">=</span><span class="token punctuation">[</span>email<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    body<span class="token operator">=</span>render_email<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'template'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    subject<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token string">'subject'</span><span class="token punctuation">]</span>
                <span class="token punctuation">)</span>
                conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
</code></pre>
<h3 id="test">Test</h3>
<p>Afin de faciliter les tests, nous allons utiliser un petit utilitaire : <code>mailcatcher</code> qui nous permet d’avoir un serveur d’envoie de email de développement</p>
<pre><code>docker run -d -p 1080:80 -p 1025:25 --name smtp_dev tophfr/mailcatcher
</code></pre>
<p>Ajoutons la configuration de <code>mailcatcher</code> dans notre fichier <code>email_service/config.py</code> :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Base configuration
    """</span>
    MAIL_SERVER <span class="token operator">=</span> <span class="token string">'localhost'</span>
    MAIL_PORT <span class="token operator">=</span> <span class="token number">1025</span>
    MAIL_USE_TLS <span class="token operator">=</span> <span class="token boolean">False</span>
    MAIL_USE_SSL <span class="token operator">=</span> <span class="token boolean">False</span>
    MAIL_USERNAME <span class="token operator">=</span> <span class="token string">''</span>
    MAIL_PASSWORD <span class="token operator">=</span> <span class="token string">''</span>
    MAIL_DEFAULT_SENDER <span class="token operator">=</span> <span class="token string">'will@dev.fr'</span>
    @<span class="token builtin">staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">init_app</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Init app
        :param app: Flask App
        :type app: Flask
        """</span>
        <span class="token keyword">pass</span>
</code></pre>
<p>Lançons et essayons d’envoyer 1 email puis 10, et regardons le temps de réponse du service, on se rend bien compte qu’assez vite le temps de réponse n’est plus viable surtout dans la mesure ou le service sera appelé par d’autres services</p>
<p>Pour palier à ça nous allons déporter l’envoi de email dans un processus différent, même si l’envoi des emails dure 1h, le service répondra et moins de 2 secondes.</p>
<p>Mais avant ça, voyons comment ajouter des logs à notre service.</p>
<h1 id="loggers">2 - Loggers</h1>
<p>Garder des traces (logs) des choses qui fonctionnent ou qui ne fonctionnent pas fait partie des bonnes pratiques lors du développement d’un programme, la manière la plus courante est d’écrire les logs dans un ou plusieurs fichiers.</p>
<h2 id="python-et-les-loggers">Python et les loggers</h2>
<p>Python possède déjà les bibliothèques nécessaires au logging, il suffit d’importer le paquet <code>logging</code></p>
<p>Exemple :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> logging

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'Mon message'</span><span class="token punctuation">)</span>
</code></pre>
<p>Sortie :</p>
<pre><code>WARNING:root:Mon message
</code></pre>
<h3 id="niveaux-de-logs">Niveaux de logs</h3>
<p>Il existe plusieurs niveaux de logs, chaque niveau correspond à un type de message</p>

<table>
<thead>
<tr>
<th>Nom</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>debug</td>
<td>A utiliser pour les diagnostics et le développement</td>
</tr>
<tr>
<td>info</td>
<td>A utiliser quand l’exécution d’une étape importante est un succès</td>
</tr>
<tr>
<td>warning</td>
<td>A utiliser lors d’une erreur non critique, exemple un serveur ne répond pas mais le programme peut continuer à fonctionner normalement</td>
</tr>
<tr>
<td>error</td>
<td>A utiliser lors d’une erreur empêchant le fonctionnement normal du programme, mais qui ne nécessite pas de quitter le programme</td>
</tr>
<tr>
<td>critical</td>
<td>A utiliser lors d’une erreur nécessitant de quitter le programme</td>
</tr>
</tbody>
</table><h3 id="logging-simple-dans-un-fichier">Logging simple dans un fichier</h3>
<p>La bibliothèque logging est très bien faite, il est aisé d’écrire les logs dans un fichier</p>
<p>Exemple :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> logging

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    basedir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>
    filename <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> <span class="token string">'my_logs.logs'</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>filename<span class="token operator">=</span>filename<span class="token punctuation">,</span> level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'Mon message'</span><span class="token punctuation">)</span>
</code></pre>
<p>Ce qui nous donne un fichier <code>my_logs.logs</code> contenant :</p>
<pre><code>WARNING:root:Mon message
</code></pre>
<p>De plus il est possible d’utiliser cette méthode même si notre programme comporte plusieurs fichiers et ce sans avoir à redéfinir le logger et le fichier à écrire.</p>
<p>Exemple :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># main.py</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> hello
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    basedir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>
    filename <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> <span class="token string">'my_logs.logs'</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>filename<span class="token operator">=</span>filename<span class="token punctuation">,</span> level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'Mon message'</span><span class="token punctuation">)</span>
    hello<span class="token punctuation">.</span>say_hello<span class="token punctuation">(</span><span class="token string">'Will'</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'Finis'</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># hello.py</span>
<span class="token keyword">import</span> logging

<span class="token keyword">def</span> <span class="token function">say_hello</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Say hello to {0}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Hello {0}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>Ce qui nous donne :</p>
<pre><code>WARNING:root:Mon message
INFO:root:Say hello to Will
WARNING:root:Finis
</code></pre>
<h3 id="logging-avancée">Logging avancée</h3>
<p>Nous avons vu la méthode la plus simple pour l’écriture de logs dans un fichier, dans le cas d’utilisation de bibliothèques (Flask par exemple) il faut découper le logging en plusieurs parties<br>
La bibliothèque <code>logging</code> nous met à disposition plusieurs objets et fonctions pour réaliser le découpage :</p>
<ul>
<li>La fonction <code>getLogger</code> qui permet d’avoir une interface de logger utilisable dans le code</li>
<li>Les objets <code>Handler</code> qui ont la charge d’envoyer les logs à la bonne destination (un fichier par exemple)</li>
<li>Les objets <code>Formatter</code> qui déterminent la manière dont les logs sont rendus</li>
</ul>
<p>Exemple :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> logging
<span class="token keyword">from</span> logging<span class="token punctuation">.</span>handlers <span class="token keyword">import</span> RotatingFileHandler

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    basedir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>
    filename <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> <span class="token string">'my_logs.log'</span><span class="token punctuation">)</span>
    <span class="token comment"># Interface</span>
    logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
    <span class="token comment"># Handler</span>
    handler <span class="token operator">=</span> RotatingFileHandler<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> maxBytes<span class="token operator">=</span><span class="token number">20000</span><span class="token punctuation">,</span> backupCount<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token comment"># Formatter</span>
    formatter <span class="token operator">=</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">(</span><span class="token string">'%(asctime)s - %(name)s - %(levelname)s: %(message)s'</span><span class="token punctuation">)</span>
    <span class="token comment"># Ajout du formatter au handler</span>
    handler<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter<span class="token punctuation">)</span>
    <span class="token comment"># Ajout du handler au logger</span>
    logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>handler<span class="token punctuation">)</span>
    <span class="token comment"># Definition du niveau de log</span>
    handler<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'Mon message'</span><span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'Finis'</span><span class="token punctuation">)</span>
</code></pre>
<p>Ce qui nous donne :</p>
<pre><code>2018-06-20 11:45:57,627 - __main__ - WARNING: Mon message 
2018-06-20 11:45:57,627 - __main__ - WARNING: Finis 
</code></pre>
<h4 id="explication">Explication</h4>
<h5 id="logger">Logger</h5>
<p><code>logging.getLogger(__name__)</code> permet de récupérer une interface de logger pour nos logs, pourquoi le <code>__name__</code> ?</p>
<p>Il est possible de donner un nom au logger, mais celui-ci doit être unique, car il représente une référence vers le logger.</p>
<p>Autrement dit, si vous créez deux logger avec le même nom, vous aurez en fait 2 variables pointant vers le même logger.</p>
<p>Exemple :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment"># Interface</span>
    logger1 <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token string">'mon_logger'</span><span class="token punctuation">)</span>
    logger2 <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token string">'mon_logger'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    logger1<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'Mon message'</span><span class="token punctuation">)</span>
    logger1<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'Finis'</span><span class="token punctuation">)</span>
    logger2<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'Mon message depuis logger 2'</span><span class="token punctuation">)</span>
    logger2<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'Finis depuis logger 2'</span><span class="token punctuation">)</span>
</code></pre>
<p>Ce qui nous donne :</p>
<pre><code>2018-06-20 11:49:51,848 - mon_logger - WARNING: Mon message 
2018-06-20 11:49:51,850 - mon_logger - WARNING: Finis 
2018-06-20 11:49:51,850 - mon_logger - WARNING: Mon message depuis logger 2 
2018-06-20 11:49:51,852 - mon_logger - WARNING: Finis depuis logger 2 
</code></pre>
<p>Nous voyons bien que malgré des noms de variables différents, il s’agit en fait d’un même logger</p>
<h5 id="handler">Handler</h5>
<p>Le <code>RotatingFileHandler</code> est le handler de fichier le plus pratique, car il permet d’écrire les logs dans des fichiers rotatifs.</p>
<p>C’est-à-dire que quand un fichier de log est considéré comme plein, le handler crée automatiquement un fichier <code>&lt;filename&gt;.log.1</code></p>
<p>Le <code>RotatingFileHandler</code> nécessite 4 paramètres :</p>
<ul>
<li>Le chemin complet du fichier ou écrire les logs</li>
<li>La taille maximale d’un fichier de log</li>
<li>Le nombre maximal de fichiers de log</li>
<li>L’encodage des fichiers de log</li>
</ul>
<h5 id="formatter">Formatter</h5>
<p>Dans le formatter, il suffit de fournir un format de log, ici on affiche <code>Date et heure - Nom du logger - Niveau du log : Message</code></p>
<pre class=" language-python"><code class="prism  language-python">formatter <span class="token operator">=</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">(</span><span class="token string">'%(asctime)s - %(name)s - %(levelname)s: %(message)s'</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="flask-et-le-logging">Flask et le logging</h2>
<p>Flask possède déjà un logger, il nous suffit de l’utiliser, reprenons notre fichier <code>email.py</code> dans le dossier <code>email_service/app/api/endpoints</code>.</p>
<p>Nous allons ajouter un log d’erreur quand une adresse email n’est pas valide, pour accéder au logger il faut utiliser <code>current_app.logger</code><br>
<code>current_app</code> est une référence de l’application Flask en cours d’utilisation</p>
<p>Exemple :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> re
<span class="token keyword">from</span> flask <span class="token keyword">import</span> request<span class="token punctuation">,</span> current_app  <span class="token comment"># Changement ici</span>
<span class="token keyword">from</span> flask_restplus <span class="token keyword">import</span> Namespace<span class="token punctuation">,</span> Resource<span class="token punctuation">,</span>abort
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>serializers<span class="token punctuation">.</span>email <span class="token keyword">import</span> send_email_model

ns <span class="token operator">=</span> Namespace<span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Email related operation'</span><span class="token punctuation">)</span>

<span class="token comment"># =========================================================================</span>
<span class="token comment"># ENDPOINTS</span>
<span class="token comment"># =========================================================================</span>
<span class="token comment">#   API email endpoints</span>
<span class="token comment">#</span>
<span class="token comment"># =========================================================================</span>

@ns<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">EmailSend</span><span class="token punctuation">(</span>Resource<span class="token punctuation">)</span><span class="token punctuation">:</span>
    @ns<span class="token punctuation">.</span>expect<span class="token punctuation">(</span>send_email_model<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Send email
        """</span>
        data <span class="token operator">=</span> request<span class="token punctuation">.</span>json
        <span class="token keyword">for</span> email <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">'recipients'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token operator">not</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span>r<span class="token string">"(^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$)"</span><span class="token punctuation">,</span> email<span class="token punctuation">)</span><span class="token punctuation">:</span>
                current_app<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'{0} not pass email regex.'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Changement ici</span>
                abort<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> error<span class="token operator">=</span><span class="token string">'{0} not pass email regex.'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>Ce qui nous donne par exemple :</p>
<pre><code> * Serving Flask app "app" (lazy loading)
 * Environment: production
   WARNING: Do not use the development server in a production environment.
   Use a production WSGI server instead.
 * Debug mode: on
 * Restarting with stat
 * Debugger is active!
 * Debugger PIN: 629-244-677
 * Running on http://localhost:5555/ (Press CTRL+C to quit)
[2018-06-20 18:04:30,986] ERROR in email: string not pass email regex.
127.0.0.1 - - [20/Jun/2018 18:04:30] "POST /api/email/ HTTP/1.1" 400 -
</code></pre>
<p>Pour pouvoir écrire les logs dans un fichier il suffit d’ajouter un handler au logger, pour cela nous allons reprendre le fichier <code>config.py</code> et y faire 2 modifications :</p>
<ul>
<li>Quelques ajouts dans la configuration afin de rendre les logs paramétrables.</li>
<li>Surcharger la méthode <code>init_app</code> pour ajouter notre handler<br>
En configuration de développement, nous écrirons les logs du service dans des fichiers.</li>
</ul>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> logging
<span class="token keyword">from</span> logging<span class="token punctuation">.</span>handlers <span class="token keyword">import</span> RotatingFileHandler

<span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Base configuration
    """</span>
    MAIL_SERVER <span class="token operator">=</span> <span class="token string">'localhost'</span>
    MAIL_PORT <span class="token operator">=</span> <span class="token number">1025</span>
    MAIL_USE_TLS <span class="token operator">=</span> <span class="token boolean">False</span>
    MAIL_USE_SSL <span class="token operator">=</span> <span class="token boolean">False</span>
    MAIL_USERNAME <span class="token operator">=</span> <span class="token string">''</span>
    MAIL_PASSWORD <span class="token operator">=</span> <span class="token string">''</span>
    MAIL_DEFAULT_SENDER <span class="token operator">=</span> <span class="token string">'will@dev.fr'</span>
    LOG_PATH <span class="token operator">=</span> <span class="token string">'&lt;your path&gt;'</span>
    LOG_SIZE <span class="token operator">=</span> <span class="token number">20000</span>
    LOG_COUNT <span class="token operator">=</span> <span class="token number">10</span>
    LOG_ENCODING <span class="token operator">=</span> <span class="token string">'utf-8'</span>
    LOG_LEVEL <span class="token operator">=</span> <span class="token string">'DEBUG'</span>
    @<span class="token builtin">staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">init_app</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Init app
        :param app: Flask App
        :type app: Flask
        """</span>
        <span class="token keyword">pass</span>

<span class="token keyword">class</span> <span class="token class-name">DevelopmentConfig</span><span class="token punctuation">(</span>Config<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Development configuration
    """</span>
    @<span class="token builtin">staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">init_app</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
        logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
        handler <span class="token operator">=</span> RotatingFileHandler<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'LOG_PATH'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                      maxBytes<span class="token operator">=</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'LOG_SIZE'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                      backupCount<span class="token operator">=</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'LOG_COUNT'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                      encoding<span class="token operator">=</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'LOG_ENCODING'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        formatter <span class="token operator">=</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">(</span>
            <span class="token string">'%(asctime)s %(levelname)s: %(message)s '</span>
            <span class="token string">'[in %(pathname)s:%(lineno)d]'</span>
        <span class="token punctuation">)</span>
        handler<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter<span class="token punctuation">)</span>
        handler<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>logging<span class="token punctuation">,</span> app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'LOG_LEVEL'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>handler<span class="token punctuation">)</span>
</code></pre>
<h1 id="celery">3 - Celery</h1>
<p>Dans certains cas, nous avons besoin de réaliser des actions en dehors du contexte d’exécution de notre programme par exemple :</p>
<ul>
<li>Dans le cas d’une interface graphique où la boucle d’exécution doit être aussi rapide que possible afin de ne pas détériorer l’expérience utilisateur</li>
<li>Dans le cas d’actions programmées dans le temps (exemple : exécuter une action dans 1h)</li>
<li>Dans le cas d’un micro-service devant réaliser des actions prenant du temps tout en répondant en moins de 1 seconde.<br>
Il est en général possible de s’en sortir avec les processus et les threads, mais cela devient très vite très complexe à mettre en oeuvre.<br>
Une solution est d’utiliser <code>Celery</code>, une bibliothèque offrant un gestionnaire de tâches et une file d’attente.</li>
</ul>
<h2 id="concept">Concept</h2>
<p>Une application utilisant <code>Celery</code> est composée d’au moins 4 éléments :</p>
<ul>
<li>L’application en elle même</li>
<li>L’application Celery, elle a la charge de réaliser nos tâches</li>
<li>Un <code>worker</code> qui a la charge d’exécuter l’application Celery</li>
<li>Une base de données permettant de stocker la file d’attente et les résultats des taches</li>
</ul>
<h2 id="installation-1">Installation</h2>
<h3 id="base-de-données">Base de données</h3>
<p>L’application Celery nécessite une base de données pour fonctionner, nous allons ici utiliser Redis car elle est facilement utilisable en Python pour d’autres projets (la liste des bases de données possibles est disponible dans la documentation).</p>
<p>Afin de faciliter l’installation et l’utilisation, nous allons utiliser Docker pour lancer notre base de données Redis.</p>
<p>Premier lancement de Redis</p>
<pre><code>docker run --name redis_dev -p 6379:6379 -d redis
</code></pre>
<blockquote>
<p>-p 6379:6379 permet de rendre Redis disponible sur notre réseau local, pratique dans les phases de développement, à éviter dans les phases de production.</p>
</blockquote>
<p>Arréter Redis</p>
<pre><code>docker stop redis_dev
</code></pre>
<p>Relancer Redis</p>
<pre><code>docker start redis_dev
</code></pre>
<h3 id="python">Python</h3>
<p>Pour installer <code>Celery</code> il suffit d’utiliser <code>pip</code></p>
<blockquote>
<p>Il faut aussi installer le connecteur <code>Redis</code></p>
</blockquote>
<pre><code>pip install celery
pip install redis
</code></pre>
<h2 id="usage-1">Usage</h2>
<h3 id="création-de-lapplication">Création de l’application</h3>
<p>Créons une application <code>Celery</code> très simple dans un fichier <code>tasks.py</code>, elle contiendra uniquement une tache <code>do_stuff</code> qui prend 30 secondes</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> time
<span class="token keyword">from</span> celery <span class="token keyword">import</span> Celery

app <span class="token operator">=</span> Celery<span class="token punctuation">(</span><span class="token string">'tasks'</span><span class="token punctuation">,</span> broker<span class="token operator">=</span><span class="token string">'redis://localhost'</span><span class="token punctuation">,</span> backend<span class="token operator">=</span><span class="token string">'redis://localhost/0'</span><span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>task
<span class="token keyword">def</span> <span class="token function">do_stuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'SUCCESS'</span>
</code></pre>
<p>La création d’une application nécessite au moins 3 choses :</p>
<ul>
<li>Un nom, ici <code>tasks</code></li>
<li>Un broker pour stocker la file d’attente.</li>
<li>Un backend pour stocker les états et les résultats<br>
Le décorateur <code>app.task</code> permet d’ajouter la fonction <code>do_stuff</code> à l’application Celey</li>
</ul>
<h3 id="lancement-du-worker">Lancement du worker</h3>
<p>Il faut ensuite lancer le worker qui exécutera notre application Celery.<br>
Dans un terminal avec l’environnement Python adéquat :</p>
<pre><code>celery -A tasks worker --loglevel=info
</code></pre>
<p>Sous Windows il est nécessaire d’utiliser une bibliothèque supplémentaire afin de pouvoir lancer le worker</p>
<pre><code>pip install eventlet
celery -A tasks worker -P eventlet --loglevel=info
</code></pre>
<p>Ce qui nous donne la sortie suivante qui indique que le système est en attente de tâches :</p>
<pre><code> -------------- celery@DESKTOP-DEV v4.2.0 (windowlicker)
---- **** -----
--- * ***  * -- Windows-10 2018-06-24 13:07:47
-- * - **** ---
- ** ---------- [config]
- ** ---------- .&gt; app:         tasks:0x2657e147a90
- ** ---------- .&gt; transport:   redis://localhost:6379//
- ** ---------- .&gt; results:     disabled://
- *** --- * --- .&gt; concurrency: 8 (eventlet)
-- ******* ---- .&gt; task events: OFF (enable -E to monitor tasks in this worker)
--- ***** -----
 -------------- [queues]
                .&gt; celery           exchange=celery(direct) key=celery

[tasks]
  . tasks.do_stuff
[2018-06-24 13:07:47,058: INFO/MainProcess] Connected to redis://localhost:6379//
[2018-06-24 13:07:47,073: INFO/MainProcess] mingle: searching for neighbors
[2018-06-24 13:07:48,144: INFO/MainProcess] mingle: all alone
[2018-06-24 13:07:48,211: INFO/MainProcess] celery@DESKTOP-DEV ready.
[2018-06-24 13:07:48,213: INFO/MainProcess] pidbox: Connected to redis://localhost:6379//.
</code></pre>
<h3 id="lancement-dune-tâche">Lancement d’une tâche</h3>
<p>Il suffit ensuite de lancer nos tâches.<br>
Dans un interpréteur Python adéquat et lancé dans le dossier contenant <code>tasks.py</code>:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> tasks <span class="token keyword">import</span> do_stuff
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> result <span class="token operator">=</span> do_stuff<span class="token punctuation">.</span>delay<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> result<span class="token punctuation">.</span>ready<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token boolean">False</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment"># 30s plus tard</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> result<span class="token punctuation">.</span>ready<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token boolean">True</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token string">'SUCCESS'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
</code></pre>
<p>Il existe 2 moyens de lancer une tâche, <code>delay</code> et <code>apply_async</code>, <code>delay</code> est une version simplifiée de <code>apply_async</code>, (en interne <code>delay</code> appel <code>apply_async</code>).</p>
<p>Nous pouvons savoir si une tâche est terminée à l’aide de <code>ready</code> et récupérer le résultat d’une tâche à l’aide de <code>get</code>.</p>
<p>Si nous regardons la sortie de notre worker nous pouvons voir que la tâche est bien un succès et que le résultat de la tâche est <code>SUCCESS</code></p>
<pre><code>[2018-06-24 13:20:33,909: INFO/MainProcess] Received task: tasks.do_stuff[8a9049b8-f33a-4747-b0f6-cb4823b7aace]
[2018-06-24 13:21:03,929: INFO/MainProcess] Task tasks.do_stuff[8a9049b8-f33a-4747-b0f6-cb4823b7aace] succeeded in 30.030999999959022s: 'SUCCESS'
</code></pre>
<h2 id="en-dehors-du-contexte-dexécution-de-notre-programme">En dehors du contexte d’exécution de notre programme</h2>
<p>Il est important de souligner que le worker est une entité séparée et qu’il est possible de l’utiliser avec un ou plusieurs programmes.</p>
<p>Pour l’illustrer, ouvrez 2 interpréteurs Python, dans le premier nous allons lancer une tâche et récupérer son identifiant unique et dans le second nous allons lire l’état de la tâche à partir de son identifiant<br>
Nous pouvons récupérer l’état d’une tâche à l’aide de <code>&lt;task&gt;.AsyncResult(&lt;task_id&gt;)</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> tasks <span class="token keyword">import</span> do_stuff
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> task <span class="token operator">=</span> do_stuff<span class="token punctuation">.</span>delay<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> task<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token string">'85de2fde-703d-47ff-9cb9-4ab64c8a76da'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
</code></pre>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> tasks <span class="token keyword">import</span> do_stuff
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> task <span class="token operator">=</span> do_stuff<span class="token punctuation">.</span>AsyncResult<span class="token punctuation">(</span><span class="token string">'85de2fde-703d-47ff-9cb9-4ab64c8a76da'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> task
<span class="token operator">&lt;</span>AsyncResult<span class="token punctuation">:</span> <span class="token number">85de2fde</span><span class="token operator">-</span><span class="token number">703d</span><span class="token operator">-</span><span class="token number">47ff</span><span class="token operator">-</span><span class="token number">9cb9</span><span class="token operator">-</span><span class="token number">4ab64c8a76da</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> task<span class="token punctuation">.</span>ready<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token boolean">False</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> task<span class="token punctuation">.</span>ready<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token boolean">True</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token string">'SUCCESS'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
</code></pre>
<p>Ce qui implique que le worker peut continuer à effectuer des tâches alors que le programme qui les a lancées n’est plus en cours d’exécution</p>
<h2 id="plus-de-détail-sur-les-taches">Plus de détail sur les taches</h2>
<p>Jusqu’à maintenant nous avons vu comment lancer une tâche et récupérer un résultat quand celle-ci est terminée.</p>
<p>Lors de tâches complexes, il est souvent important de connaitre l’état d’avancement ou l’étape en cours.</p>
<p>Pour réaliser cela il y a 3 choses à faire :</p>
<ul>
<li>Ajouter <code>bind=True</code> à notre décorateur, ce qui permettra d’accéder à l’instance de la tâche dans la fonction</li>
<li>Ajouter le paramètre <code>self</code> en premier paramètre de la fonction</li>
<li>Mettre à jour l’instance de la classe aux étapes importantes à l’aide de <code>self.update_state</code><br>
Il est ensuite possible d’accéder aux informations de la tâche à l’aide de <code>&lt;task&gt;.info</code></li>
</ul>
<p>Exemple</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> time
<span class="token keyword">from</span> celery <span class="token keyword">import</span> Celery

app <span class="token operator">=</span> Celery<span class="token punctuation">(</span><span class="token string">'tasks'</span><span class="token punctuation">,</span> broker<span class="token operator">=</span><span class="token string">'redis://localhost'</span><span class="token punctuation">,</span>  backend<span class="token operator">=</span><span class="token string">'redis://localhost/0'</span><span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>task<span class="token punctuation">(</span>bind<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">do_stuff</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    state <span class="token operator">=</span> <span class="token string">'PROGRESS'</span>
    meta <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'total'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token string">'current'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'Loading file'</span><span class="token punctuation">,</span>
        <span class="token string">'result'</span><span class="token punctuation">:</span> <span class="token boolean">False</span>
    <span class="token punctuation">}</span>
    self<span class="token punctuation">.</span>update_state<span class="token punctuation">(</span>state<span class="token operator">=</span>state<span class="token punctuation">,</span> meta<span class="token operator">=</span>meta<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    meta<span class="token punctuation">[</span><span class="token string">'current'</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
    meta<span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Parse file'</span>
    self<span class="token punctuation">.</span>update_state<span class="token punctuation">(</span>state<span class="token operator">=</span>state<span class="token punctuation">,</span> meta<span class="token operator">=</span>meta<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    meta<span class="token punctuation">[</span><span class="token string">'current'</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
    meta<span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Do some stuff'</span>
    self<span class="token punctuation">.</span>update_state<span class="token punctuation">(</span>state<span class="token operator">=</span>state<span class="token punctuation">,</span> meta<span class="token operator">=</span>meta<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    meta<span class="token punctuation">[</span><span class="token string">'current'</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
    meta<span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Stuff completed'</span>
    meta<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> meta
</code></pre>
<p>Dans un interpréteur Python adéquat :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">import</span> time
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> tasks <span class="token keyword">import</span> do_stuff
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">show_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  task <span class="token operator">=</span> do_stuff<span class="token punctuation">.</span>delay<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token keyword">while</span> <span class="token operator">not</span> task<span class="token punctuation">.</span>ready<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   <span class="token keyword">print</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>info<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token keyword">print</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> show_task<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token boolean">None</span>
<span class="token punctuation">{</span><span class="token string">'total'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'current'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'Loading file'</span><span class="token punctuation">,</span> <span class="token string">'result'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">'total'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'current'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'Parse file'</span><span class="token punctuation">,</span> <span class="token string">'result'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">'total'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'current'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'Parse file'</span><span class="token punctuation">,</span> <span class="token string">'result'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">'total'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'current'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'Do some stuff'</span><span class="token punctuation">,</span> <span class="token string">'result'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">'total'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'current'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'Do some stuff'</span><span class="token punctuation">,</span> <span class="token string">'result'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">'total'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'current'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'Stuff completed'</span><span class="token punctuation">,</span> <span class="token string">'result'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
</code></pre>
<h2 id="celery-et-flask">Celery et Flask</h2>
<p>Celery est très intéressant avec Flask, car cela permet de créer un service qui répond très rapidement malgré des tâches longues à réaliser.</p>
<p>Dans le cas de notre service d’envoi de email, même si un envoi dure 10 minutes, le micro service répondra instantanément et sera capable de fournir l’état d’avancement de l’envoi.</p>
<p>De plus il est même possible de programmer un minuteur avant l’envoi</p>
<h3 id="mise-en-place">Mise en place</h3>
<p>Pour pouvoir utiliser Celery avec notre service Flask, il faut ajouter une usine à application Celery dans le fichier <code>email_service/app/__init.py</code></p>
<p>Le code de l’usine à Celery provient directement de la documentation Flask :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> celery <span class="token keyword">import</span> Celery
<span class="token keyword">from</span> config <span class="token keyword">import</span> config

<span class="token keyword">def</span> <span class="token function">make_celery</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Create Celery application
    
    :param app: Flask application
    :type app: Flask
    
    :return: Celery application
    :rtype: Celery
    """</span>
    celery <span class="token operator">=</span> Celery<span class="token punctuation">(</span>app<span class="token punctuation">.</span>import_name<span class="token punctuation">,</span> backend<span class="token operator">=</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'CELERY_RESULT_BACKEND'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    broker<span class="token operator">=</span>app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'CELERY_BROKER_URL'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    celery<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>update<span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
    TaskBase <span class="token operator">=</span> celery<span class="token punctuation">.</span>Task
    <span class="token keyword">class</span> <span class="token class-name">ContextTask</span><span class="token punctuation">(</span>TaskBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
        abstract <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> app<span class="token punctuation">.</span>app_context<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> TaskBase<span class="token punctuation">.</span>__call__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    celery<span class="token punctuation">.</span>Task <span class="token operator">=</span> ContextTask
    <span class="token keyword">return</span> celery

<span class="token keyword">def</span> <span class="token function">create_app</span><span class="token punctuation">(</span>config_name<span class="token operator">=</span><span class="token string">'default'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Create application
    :param config_name: Configuration name
    :type config_name: str
    :return: Flask app
    :rtype: Flask
    """</span>
    <span class="token comment"># Import blueprint here</span>
    <span class="token comment"># from .xxx import blueprint as xxx_blueprint</span>
    <span class="token keyword">from</span> <span class="token punctuation">.</span>api <span class="token keyword">import</span> blueprint <span class="token keyword">as</span> api_blueprint
    app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">[</span>config_name<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># Register blueprint here</span>
    <span class="token comment"># app.register_blueprint(xxx_blueprint)</span>
    app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>api_blueprint<span class="token punctuation">)</span>
    extensions<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    <span class="token keyword">return</span> app

<span class="token keyword">def</span> <span class="token function">extensions</span><span class="token punctuation">(</span>flask_app<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Init extensions
    :param flask_app:
    """</span>
    <span class="token keyword">pass</span>
</code></pre>
<p>Nous voyons que Celery nécessite <code>CELERY_RESULT_BACKEND</code> et <code>CELERY_BROKER_URL</code> dans la configuration, ajoutons les propriétés dans notre fichier <code>email_service/config.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> logging
<span class="token keyword">from</span> logging<span class="token punctuation">.</span>handlers <span class="token keyword">import</span> RotatingFileHandler

<span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Base configuration
    """</span>
    MAIL_SERVER <span class="token operator">=</span> <span class="token string">'localhost'</span>
    MAIL_PORT <span class="token operator">=</span> <span class="token number">1025</span>
    MAIL_USE_TLS <span class="token operator">=</span> <span class="token boolean">False</span>
    MAIL_USE_SSL <span class="token operator">=</span> <span class="token boolean">False</span>
    MAIL_USERNAME <span class="token operator">=</span> <span class="token string">''</span>
    MAIL_PASSWORD <span class="token operator">=</span> <span class="token string">''</span>
    MAIL_DEFAULT_SENDER <span class="token operator">=</span> <span class="token string">'will@dev.fr'</span>
    CELERY_RESULT_BACKEND <span class="token operator">=</span> <span class="token string">'redis://localhost/0'</span>
    CELERY_BROKER_URL <span class="token operator">=</span> <span class="token string">'redis://localhost'</span>
    LOG_PATH <span class="token operator">=</span> <span class="token string">''</span>
    LOG_SIZE <span class="token operator">=</span> <span class="token number">20000</span>
    LOG_COUNT <span class="token operator">=</span> <span class="token number">10</span>
    LOG_ENCODING <span class="token operator">=</span> <span class="token string">'utf-8'</span>
    LOG_LEVEL <span class="token operator">=</span> <span class="token string">'DEBUG'</span>
    @<span class="token builtin">staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">init_app</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Init app
        :param app: Flask App
        :type app: Flask
        """</span>
        <span class="token keyword">pass</span>
</code></pre>
<h3 id="création-de-la-tache-denvoi-de-email">Création de la tache d’envoi de email</h3>
<p>Maintenant que nous avons lié Celery à notre application Flask, nous pouvons reprendre ce que nous avons vu précédemment.</p>
<p>Créons un fichier <code>tasks.py</code> dans le dossier <code>email_service/app/</code> et ajoutons la logique d’envoi de emails</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">from</span> flask <span class="token keyword">import</span> current_app
<span class="token keyword">from</span> flask_mail <span class="token keyword">import</span> Message
<span class="token keyword">from</span> email<span class="token punctuation">.</span>utils <span class="token keyword">import</span> format_datetime
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> make_celery
<span class="token keyword">from</span> <span class="token punctuation">.</span>extensions <span class="token keyword">import</span> mail
<span class="token keyword">from</span> <span class="token punctuation">.</span>utils <span class="token keyword">import</span> render_email
celery <span class="token operator">=</span> make_celery<span class="token punctuation">(</span><span class="token punctuation">)</span>

@celery<span class="token punctuation">.</span>task<span class="token punctuation">(</span>bind<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">send_email</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> current_app<span class="token punctuation">.</span>app_context<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> mail<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
                <span class="token keyword">for</span> address <span class="token keyword">in</span> args<span class="token punctuation">[</span><span class="token string">'recipients'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    data <span class="token operator">=</span> <span class="token punctuation">{</span>
                        <span class="token string">'date'</span><span class="token punctuation">:</span> format_datetime<span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string">'to'</span><span class="token punctuation">:</span> address<span class="token punctuation">,</span>
                        <span class="token string">'from'</span><span class="token punctuation">:</span> current_app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'MAIL_DEFAULT_SENDER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token string">'subject'</span><span class="token punctuation">:</span> args<span class="token punctuation">[</span><span class="token string">'subject'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token string">'content'</span><span class="token punctuation">:</span> args<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span>
                    <span class="token punctuation">}</span>
                    msg <span class="token operator">=</span> Message<span class="token punctuation">(</span>
                        recipients<span class="token operator">=</span><span class="token punctuation">[</span>address<span class="token punctuation">]</span><span class="token punctuation">,</span>
                        body<span class="token operator">=</span>render_email<span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token string">'template'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        subject<span class="token operator">=</span>args<span class="token punctuation">[</span><span class="token string">'subject'</span><span class="token punctuation">]</span>
                    <span class="token punctuation">)</span>
                    conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> ex<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ex
</code></pre>
<p>La ligne <code>with current_app.app_context()</code> permet d’être sûr que l’extension mail est initialisée et cela nous permet de lire la configuration de l’application Flask en cours</p>
<h3 id="utilisation-de-la-tache">Utilisation de la tache</h3>
<p>Maintenant que tout est en place, nous pouvons mettre en place l’envoi de fichiers en complètent la méthode d’envoi dans le fichier <code>email_service/app/api/endpoints/email.py</code>.</p>
<p>Une fois la tâche lancée, le service retournera l’identifiant de la tâche afin que l’utilisateur puisse suivre l’évolution.</p>
<p>Pour cela commençons par modifier le fichier <code>email_service/app/api/serializers/email.py</code> afin de définir le format de sortie de notre service</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> flask_restplus <span class="token keyword">import</span> fields
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">import</span> api

send_email_model <span class="token operator">=</span> api<span class="token punctuation">.</span>model<span class="token punctuation">(</span><span class="token string">'Send Email model'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'recipients'</span><span class="token punctuation">:</span> fields<span class="token punctuation">.</span>List<span class="token punctuation">(</span>fields<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Recipients list'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'subject'</span><span class="token punctuation">:</span> fields<span class="token punctuation">.</span>String<span class="token punctuation">(</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Email subject'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'content'</span><span class="token punctuation">:</span> fields<span class="token punctuation">.</span>String<span class="token punctuation">(</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Email content'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'template'</span><span class="token punctuation">:</span> fields<span class="token punctuation">.</span>String<span class="token punctuation">(</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Email template'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
send_email_reponse <span class="token operator">=</span> api<span class="token punctuation">.</span>model<span class="token punctuation">(</span><span class="token string">'Send Email response'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'id'</span><span class="token punctuation">:</span> fields<span class="token punctuation">.</span>String<span class="token punctuation">(</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Send email task id'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>Nous pouvons maintenant modifier le fichier <code>email_service/app/api/endpoints/email.py</code> afin d’appeler la tâche d’envoi de email</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> re
<span class="token keyword">from</span> flask <span class="token keyword">import</span> request<span class="token punctuation">,</span> current_app
<span class="token keyword">from</span> flask_restplus <span class="token keyword">import</span> Namespace<span class="token punctuation">,</span> Resource<span class="token punctuation">,</span> abort
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>serializers<span class="token punctuation">.</span>email <span class="token keyword">import</span> send_email_model

ns <span class="token operator">=</span> Namespace<span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Email related operation'</span><span class="token punctuation">)</span>

<span class="token comment"># =========================================================================</span>
<span class="token comment"># ENDPOINTS</span>
<span class="token comment"># =========================================================================</span>
<span class="token comment">#   API email endpoints</span>
<span class="token comment">#</span>
<span class="token comment"># =========================================================================</span>

@ns<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">EmailSend</span><span class="token punctuation">(</span>Resource<span class="token punctuation">)</span><span class="token punctuation">:</span>
    @ns<span class="token punctuation">.</span>expect<span class="token punctuation">(</span>send_email_model<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Send email
        """</span>
        data <span class="token operator">=</span> request<span class="token punctuation">.</span>json
        <span class="token keyword">for</span> email <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">'recipients'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token operator">not</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span>r<span class="token string">"(^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$)"</span><span class="token punctuation">,</span> email<span class="token punctuation">)</span><span class="token punctuation">:</span>
                current_app<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'{0} not pass email regex.'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">)</span>
                abort<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> error<span class="token operator">=</span><span class="token string">'{0} not pass email regex.'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">from</span> app<span class="token punctuation">.</span>tasks <span class="token keyword">import</span> send_email
        task <span class="token operator">=</span> send_email<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>args<span class="token operator">=</span><span class="token punctuation">[</span>data<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">'id'</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span>
</code></pre>
<h3 id="lancement">Lancement</h3>
<p>Il nous reste maintenant à démarrer le worker Celery et notre application</p>
<p>Lancer le worker :</p>
<pre><code>celery -A app.tasks worker -P eventlet --loglevel=info
</code></pre>
<h1 id="docker">4 - Docker</h1>
<p>Nous allons maintenant voir comment créer un container de notre application, cela passe par 3 étapes :</p>
<ul>
<li>Utiliser un serveur HTTP, le serveur HTTP de développement n’étant pas recommandé pour de la production</li>
<li>Créer un container de notre application flask et son worker</li>
<li>Créer un <code>docker-compose.yml</code> afin de packager notre application Flask avec la base de données Redis et le serveur smtp de développement</li>
</ul>
<h2 id="créer-un-container-de-notre-application-flask">Créer un container de notre application Flask</h2>
<p>Avant de créer un container de notre application, nous allons la rendre encore plus configurable.</p>
<p>Actuellement la configuration de notre application est stockée dans le fichier <code>email_service/config.py</code> et une fois insérée dans un container, nous ne pourrons plus modifier les valeurs sans reconstruire le container.</p>
<p>Pour pallier à ça, nous allons utiliser les variables d’environnement</p>
<h3 id="variables-denvironnement">Variables d’environnement</h3>
<p>Voyons dans un premier temps les variables d’environnement.<br>
Modifions le fichier <code>email_service/config.py</code> afin que chaque propriété soit surchargeable avec des variables d’environnement :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> logging
<span class="token keyword">from</span> logging<span class="token punctuation">.</span>handlers <span class="token keyword">import</span> RotatingFileHandler
basedir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Base configuration
    """</span>
    MAIL_SERVER <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'MAIL_SERVER'</span><span class="token punctuation">,</span> <span class="token string">'localhost'</span><span class="token punctuation">)</span>
    MAIL_PORT <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'MAIL_PORT'</span><span class="token punctuation">,</span> <span class="token string">'1025'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    MAIL_USE_TLS <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'MAIL_USE_TLS'</span><span class="token punctuation">,</span> <span class="token string">'False'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'True'</span>
    MAIL_USE_SSL <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'MAIL_USE_SSL'</span><span class="token punctuation">,</span> <span class="token string">'False'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'True'</span>
    MAIL_USERNAME <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'MAIL_USERNAME'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    MAIL_PASSWORD <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'MAIL_PASSWORD'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    MAIL_DEFAULT_SENDER <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'MAIL_DEFAULT_SENDER'</span><span class="token punctuation">,</span> <span class="token string">'dev@dev.dev'</span><span class="token punctuation">)</span>
    CELERY_RESULT_BACKEND <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'CELERY_RESULT_BACKEND'</span><span class="token punctuation">,</span> <span class="token string">'redis://localhost/0'</span><span class="token punctuation">)</span>
    CELERY_BROKER_URL <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'CELERY_BROKER_URL'</span><span class="token punctuation">,</span> <span class="token string">'redis://localhost'</span><span class="token punctuation">)</span>
    LOG_PATH <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'LOG_PATH'</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> <span class="token string">'logs.log'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    LOG_SIZE <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'LOG_SIZE'</span><span class="token punctuation">,</span> <span class="token string">'20000'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    LOG_COUNT <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'LOG_COUNT'</span><span class="token punctuation">,</span> <span class="token string">'10'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    LOG_ENCODING <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'LOG_ENCODING'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    LOG_LEVEL <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'LOG_LEVEL'</span><span class="token punctuation">,</span> <span class="token string">'DEBUG'</span><span class="token punctuation">)</span>
    @<span class="token builtin">staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">init_app</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Init app
        :param app: Flask App
        :type app: Flask
        """</span>
        <span class="token keyword">pass</span>
</code></pre>
<p>Si nous relançons notre programme, rien ne change, mais nous pouvons maintenant redéfinir l’ensemble de la configuration</p>
<h3 id="serveur-http-de-production">Serveur HTTP de production</h3>
<p>Le serveur de développement de Flask n’étant pas conseillé en production, nous allons donc utiliser le serveur web <code>uwsgi</code></p>
<h4 id="installation-2">Installation</h4>
<p>Pour installer <code>uwsgi</code> il suffit d’utiliser pip</p>
<pre><code>pip install uwsgi
</code></pre>
<p>Il faut ensuite ajouter un fichier <code>wsgi.py</code> que le serveur <code>uwsgi</code> ira lire :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> runserver <span class="token keyword">import</span> app <span class="token keyword">as</span> application
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    application<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="dockerfile">Dockerfile</h3>
<p>Il est maintenant temps de créer un container de notre application, pour cela nous allons créer un <code>Dockerfile</code>.</p>
<p>Créons un dossier <code>docker</code> dans le dossier <code>email_service</code> puis créons un fichier <code>Dockerfile</code></p>
<pre class=" language-dockerfile"><code class="prism  language-dockerfile"><span class="token keyword">FROM</span> python<span class="token punctuation">:</span>3
<span class="token keyword">ADD</span> ./requirements.txt /tmp/
<span class="token keyword">RUN</span> pip3 install <span class="token punctuation">-</span>r /tmp/requirements.txt
<span class="token keyword">ADD</span> ./app/ /app/
<span class="token keyword">ADD</span> ./*.py /
</code></pre>
<p>Rien de compliqué ici, nous partons d’une base Python 3, nous installons les requirements et nous ajoutons l’ensemble des fichiers de notre programme.</p>
<p>Nous pouvons maintenant construire notre container :</p>
<pre><code>docker build -t email_dev -f .\docker\Dockerfile .
</code></pre>
<p>Une fois construits, nous pouvons lancer notre service avec la commande suivante :</p>
<pre><code>docker run --name email_dev -d -p 8000:8000 email_dev uwsgi --socket 0.0.0.0:8000 --protocol=http -w wsgi
</code></pre>
<p>Nous pouvons maintenant nous rendre à l’adresse <code>http://localhost:8000/api</code> et voir que notre service fonctionne.</p>
<p>Par contre nous n’avons pas démarré notre worker.</p>
<p>Pour démarrer notre worket et notre service en même temps nous allons créer un fichier <code>start.sh</code> dans le dossier <code>email_service</code> qui contiendra les commandes pour lancer notre worker et notre application</p>
<pre class=" language-sh"><code class="prism  language-sh">#!/bin/sh
celery multi start emailworker -A app.tasks
uwsgi --socket 0.0.0.0:8000 --protocol=http -w wsgi
</code></pre>
<p>Il faut ensuite modifier et reconstruire notre image.</p>
<pre class=" language-dockerfile"><code class="prism  language-dockerfile"><span class="token keyword">FROM</span> python<span class="token punctuation">:</span>3
<span class="token keyword">ADD</span> ./requirements.txt /tmp/
<span class="token keyword">RUN</span> pip3 install <span class="token punctuation">-</span>r /tmp/requirements.txt
<span class="token keyword">ADD</span> ./app/ /app/
<span class="token keyword">ADD</span> ./*.py /
<span class="token keyword">ADD</span> ./start.sh /
</code></pre>
<p>Maintenant nous pouvons lancer notre container à l’aide</p>
<pre><code>docker run --name email_dev -d -p 8000:8000 email_dev sh start.sh
</code></pre>
<p>Mais cela ne fonctionnera pas, car maintenant notre container n’a plus accès à Redis et MailCatcher il faut donc reconfigurer les adresses de Redis et de MailCatcher<br>
Ce qui nous donne en fait :</p>
<pre><code>docker run --name email_dev -d -p 8000:8000 -e MAIL_SERVER=smtp_dev -e CELERY_RESULT_BACKEND=redis://redis_dev/0 -e CELERY_BROKER_URL=redis://r
edis_dev -e MAIL_PORT=25 --link redis_dev:redis_dev --link smtp_dev:smtp_dev email_dev sh start.sh
</code></pre>
<p>Voilà notre service est fonctionnel et accessible à l’adresse <code>http://localhost:8000/api</code> et notre MailCatcher à l’adresse <code>http://localhost:1080</code></p>
<h2 id="packager-notre-application-et-son-environnement">Packager notre application et son environnement</h2>
<p>L’étape suivante est de packager l’application et son environnement, pour cela nous allons créer un fichier <code>docker-compose.yml</code> qui contiendra notre application ainsi que Redis et MailCatcher</p>
<pre class=" language-dockercompose"><code class="prism  language-dockercompose">version: '2'
services:
  email:
    image: email_dev
    command: sh start.sh
    environment:
      - MAIL_SERVER=smtp
      - MAIL_PORT=25
      - CELERY_RESULT_BACKEND=redis://redis/0
      - CELERY_BROKER_URL=redis://redis
    ports:
      - 80:8000
    networks:
      - services_network
  redis:
    image: redis
    networks:
      - services_network
  smtp:
    image: tophfr/mailcatcher
    ports:
      - 1080:80
    networks:
      - services_network
networks:
  services_network:
    driver: bridge
</code></pre>
<p>Pour lancer notre service, il suffit de lancer la commande :</p>
<pre><code>docker-compose up -d
</code></pre>
<p>Notre service est maintenant disponible à l’adresse <code>http://localhost/api</code> et notre MailCatcher à l’adresse <code>http://localhost:1080</code><br>
Pour éteindre notre service il suffit de lancer la commande :</p>
<pre><code>docker-compose stop
</code></pre>
<h1 id="nginx">5 - Nginx</h1>
<p>Actuellement nous avons 2 problèmes :</p>
<ul>
<li>Notre service est directement accessible sur le réseau</li>
<li>Si nous lançons plusieurs services, nous devons ouvrir un port par service</li>
</ul>
<p>Pour pallier à ça, nous allons utiliser Nginx en tant que proxy inverse</p>
<h2 id="mise-en-place-1">Mise en place</h2>
<p>Pour mettre en place Nginx nous devons modifier notre <code>Dockerfile</code> et notre <code>docker-compose.yml</code></p>
<h3 id="application">Application</h3>
<p>La première chose à faire et d’ajouter un fichier de configuration pour <code>uwsgi</code> afin de configurer le service web et d’utiliser les sockets pour la communication service &lt;–&gt; réseau.</p>
<p>Créons un fichier <code>app.ini</code> dans le dossier <code>email_service</code></p>
<pre class=" language-ini"><code class="prism  language-ini"><span class="token selector">[uwsgi]</span>
<span class="token constant">mount</span> <span class="token attr-value"><span class="token punctuation">=</span> /=wsgi.py</span>
<span class="token constant">manage-script-name</span> <span class="token attr-value"><span class="token punctuation">=</span> true</span>
<span class="token constant">master</span> <span class="token attr-value"><span class="token punctuation">=</span> true</span>
<span class="token constant">processes</span> <span class="token attr-value"><span class="token punctuation">=</span> 5</span>
<span class="token constant">socket</span> <span class="token attr-value"><span class="token punctuation">=</span> /var/sockets/email.socket</span>
<span class="token constant">chmod-socket</span> <span class="token attr-value"><span class="token punctuation">=</span> 666</span>
<span class="token constant">vacuum</span> <span class="token attr-value"><span class="token punctuation">=</span> true</span>
<span class="token constant">die-on-term</span> <span class="token attr-value"><span class="token punctuation">=</span> true</span>
</code></pre>
<p>Nous allons ensuite créer un fichier <code>start_socket.sh</code></p>
<pre><code>#!/bin/sh
celery multi start emailworker -A app.tasks --loglevel=INFO --logfile=/var/log/%n%I.log --concurrency=2
uwsgi --ini app.ini
</code></pre>
<p>Modifions le fichier <code>email_service/docker/Dockerfile</code> afin d’inclure tout les fichiers .sh et notre fichier .ini</p>
<pre><code>FROM python:3
ADD ./requirements.txt /tmp/
RUN pip3 install -r /tmp/requirements.txt
ADD ./app/ /app/
ADD ./*.ini /
ADD ./*.py /
ADD ./*.sh /
</code></pre>
<p>Il faut maintenant reconstruire notre container</p>
<pre><code>docker build -t email_dev -f .\docker\Dockerfile .
</code></pre>
<h3 id="package">Package</h3>
<p>La prochaine étape est de modifier notre fichier <code>docker-compose.yml</code> afin d’intégrer Nginx et les sockets</p>
<h4 id="nginx-1">Nginx</h4>
<p>Avant de modifier le fichier <code>docker-compose.yml</code>, nous allons devoir reconstruire le container Nginx pour prendre en compte notre service, pour cela créons un dossier <code>nginx</code> dans le dossier <code>email_service/docker</code>.</p>
<p>Dans ce dossier, créons un fichier <code>services.conf</code></p>
<pre class=" language-conf"><code class="prism  language-conf">server {
  listen 80;
  charset utf-8;
  location / {
    uwsgi_pass unix:/var/sockets/email.socket;
    uwsgi_param SCRIPT_NAME /;
    uwsgi_modifier1 30;
    include uwsgi_params;
  }
}
</code></pre>
<p>Puis créons un fichier <code>Dockerfile</code> qui construira notre nouveau container Nginx :</p>
<pre><code>FROM nginx
RUN rm /etc/nginx/conf.d/default.conf
COPY services.conf /etc/nginx/conf.d/
</code></pre>
<h4 id="docker-compose">Docker compose</h4>
<p>Nous pouvons maintenant modifier notre fichier <code>docker-compose.yml</code> afin d’y ajouter Nginx.</p>
<p>Afin que Nginx ait accès à notre socket <code>email.socket</code>, nous mettons en place un volume</p>
<pre class=" language-dockercompose"><code class="prism  language-dockercompose">version: '2'
services:
  nginx:
      build: ./nginx
      ports:
        - 80:80
      networks:
        - services_network
      volumes:
        - sockets:/var/sockets/
  email:
    image: email_dev
    command: sh start_socket.sh
    environment:
      - MAIL_SERVER=smtp
      - MAIL_PORT=25
      - CELERY_RESULT_BACKEND=redis://redis/0
      - CELERY_BROKER_URL=redis://redis
    networks:
      - services_network
    volumes:
      - sockets:/var/sockets/
  redis:
    image: redis
    networks:
      - services_network
  smtp:
    image: tophfr/mailcatcher
    ports:
      - 1080:80
    networks:
      - services_network
volumes:
  sockets:
    driver: local
networks:
  services_network:
    driver: bridge
</code></pre>

    </div>
  </div>
</body>

</html>
